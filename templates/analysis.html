<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Health Analysis - Random Forest</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #050505; color: white; font-family: sans-serif; text-align: center; }
        .dashboard-container { max-width: 1000px; margin: 50px auto; padding: 20px; position: relative; }
        
        /* Back Button Style */
        .back-btn {
            position: absolute;
            top: 0;
            left: 0;
            background: #222;
            color: white;
            border: 1px solid #444;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9em;
            transition: 0.3s;
        }
        .back-btn:hover { background: #ff5722; border-color: #ff5722; }

        /* Sensor Input Hub Styles */
        .sensor-input-hub {
            background: #111;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #333;
            margin: 20px 0 40px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .sensor-box { display: flex; flex-direction: column; gap: 5px; }
        .sensor-box label { font-size: 0.7rem; color: #ff5722; text-transform: uppercase; font-weight: bold; }
        .sensor-box input { 
            background: #000; border: 1px solid #444; color: #fff; 
            padding: 8px; border-radius: 5px; text-align: center; 
        }

        /* Attribute Grid */
        .attribute-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .slider-card {
            background: #111;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #333;
            transition: 0.3s;
        }
        .slider-card:hover { border-color: #ff5722; box-shadow: 0 0 10px rgba(255,87,34,0.3); }
        .slider-card label { color: #ff5722; display: block; margin-bottom: 5px; font-weight: bold; } /* Slightly reduced margin to fit range text */
        
        /* NEW STYLE FOR RANGE INFO */
        .range-info {
            font-size: 0.75rem;
            color: #888;
            display: block;
            margin-bottom: 10px;
        }

        input[type="range"] { width: 100%; accent-color: #ff5722; cursor: pointer; }

        /* Glowing Indicators */
        .glowing-circle {
            width: 80px; height: 80px; border-radius: 50%;
            margin: 20px auto; background: #222;
            transition: 0.8s all ease-in-out;
        }
        .glow-red { background: #ff4d4d; box-shadow: 0 0 30px #ff4d4d, 0 0 60px #ff4d4d; }
        .glow-green { background: #00ff88; box-shadow: 0 0 30px #00ff88, 0 0 60px #00ff88; }

        .model-box {
            background: #1a1a1a; padding: 20px; border-radius: 15px;
            border-left: 6px solid #ff5722; display: inline-block; margin-top: 30px;
        }
        .recommendation-area { margin-top: 30px; }
        
        .sub-btn {
            background: #222; color: white; border: 1px solid #444;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            margin: 5px; transition: 0.3s;
        }
        .sub-btn:hover { background: #ff5722; border-color: #ff5722; }

        #graph-section {
            margin-top: 30px; background: #111; padding: 20px;
            border-radius: 15px; border: 1px solid #222;
        }

        .fade-in { animation: fadeIn 1s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="dashboard-container fade-in">
        <a href="{{ url_for('project') }}" class="back-btn">‚Üê Back</a>

        <h1>AI Toxicity & Health Detector</h1>
        <p style="color: #888;">Algorithm: Random Forest Classifier (Analyzing CSV Averages...)</p>

        <div class="sensor-input-hub">
            <div class="sensor-box"><label>pH</label><input type="number" id="box-ph" value="6.5" oninput="syncFromBox('ph', this.value)"></div>
            <div class="sensor-box"><label>N</label><input type="number" id="box-n" value="40" oninput="syncFromBox('n', this.value)"></div>
            <div class="sensor-box"><label>P</label><input type="number" id="box-p" value="30" oninput="syncFromBox('p', this.value)"></div>
            <div class="sensor-box"><label>K</label><input type="number" id="box-k" value="25" oninput="syncFromBox('k', this.value)"></div>
            <div class="sensor-box"><label>OM</label><input type="number" id="box-om" value="3.0" oninput="syncFromBox('om', this.value)"></div>
            <div class="sensor-box"><label>SM</label><input type="number" id="box-sm" value="50" oninput="syncFromBox('sm', this.value)"></div>
            <div class="sensor-box"><label>PM</label><input type="number" id="box-pm" value="90" oninput="syncFromBox('pm', this.value)"></div>
            <div class="sensor-box"><label>HI</label><input type="number" id="box-hi" value="95" oninput="syncFromBox('hi', this.value)"></div>
        </div>

        <button class="sub-btn" onclick="fetchCSVData()">üì• Load CSV Data</button>

        <hr style="border: 0; border-top: 1px solid #222; margin: 40px 0;">

<!-- ================= INPUT SECTION ================= -->
<h2 style="margin-top:20px;color:#ff5722;">INPUT PARAMETERS</h2>
<div class="attribute-grid">

    <div class="slider-card">
        <label>pH Level: <span id="v-ph">6.5</span></label>
        <span class="range-info">(Ideal Range: 6.0 - 7.5)</span>
        <input type="range" id="ph" min="0" max="14" step="0.1" value="6.5" oninput="updateVal('ph', this.value)">
    </div>

    <div class="slider-card">
        <label>Nitrogen (N): <span id="v-n">40</span></label>
        <span class="range-info">(Ideal Limit: ‚â§ 55)</span>
        <input type="range" id="n" min="0" max="100" value="40" oninput="updateVal('n', this.value)">
    </div>

    <div class="slider-card">
        <label>Phosphorous (P): <span id="v-p">30</span></label>
        <span class="range-info">(Ideal Range: 20 - 60)</span>
        <input type="range" id="p" min="0" max="100" value="30" oninput="updateVal('p', this.value)">
    </div>

    <div class="slider-card">
        <label>Potassium (K): <span id="v-k">25</span></label>
        <span class="range-info">(Ideal Range: 20 - 60)</span>
        <input type="range" id="k" min="0" max="100" value="25" oninput="updateVal('k', this.value)">
    </div>

    <div class="slider-card">
        <label>Organic Matter: <span id="v-om">3.0</span></label>
        <span class="range-info">(Ideal Min: ‚â• 2.0)</span>
        <input type="range" id="om" min="0" max="10" step="0.1" value="3.0" oninput="updateVal('om', this.value)">
    </div>

</div>


<!-- ================= OUTPUT SECTION ================= -->
<h2 style="margin-top:40px;color:#00bcd4;">OUTPUT PARAMETERS</h2>
<div class="attribute-grid">

    <div class="slider-card">
        <label>Soil Moisture: <span id="v-sm">50</span></label>
        <span class="range-info">(Auto Calculated)</span>
        <input type="range" id="sm" min="0" max="100" value="50" disabled>
    </div>

    <div class="slider-card">
        <label>Pest Mortality: <span id="v-pm">90</span></label>
        <span class="range-info">(Auto Calculated)</span>
        <input type="range" id="pm" min="0" max="100" value="90" disabled>
    </div>

    <div class="slider-card">
        <label>Health Index: <span id="v-hi">95</span></label>
        <span class="range-info">(Auto Calculated)</span>
        <input type="range" id="hi" min="0" max="100" value="95" disabled>
    </div>

</div>

        <button class="sub-btn" style="padding: 15px 40px; font-size: 1.1em;" onclick="runRandomForest()">Predict Toxicity</button>

        <div style="margin-top: 30px;">
            <p style="color: #888; margin-bottom: 5px; font-size: 0.9em;">AVERAGE INPUT</p>
            <h2 id="avg-display" style="color: #ff5722; margin: 0;">0.00</h2>
        </div>

        <div id="status-light" class="glowing-circle"></div>
        <h2 id="prediction-text" style="color: #555;">Waiting for Input...</h2>

        <div class="model-box">
            <p><strong>Model Used:</strong> Random Forest Classifier</p>
            <p style="color: #ff5722; font-weight: bold;">Accuracy: 98.6% | Precision: 97.4%</p>
        </div>

        <div id="recommendations" class="recommendation-area"></div>

        <div style="margin-top: 50px;">
            <button class="sub-btn" style="width: 100%; padding: 20px; font-weight: bold; font-size: 1.2em; background: linear-gradient(45deg, #111, #222); border-color: #ff5722;" onclick="toggleGraph()">üìä SENSOR DATA (SHOW GRAPH)</button>
        </div>

        <div id="graph-section" style="display: none;" class="fade-in">
            <div style="margin-bottom: 20px;">
                <button class="sub-btn" onclick="updateChartType('bar')">Bar Graph</button>
                <button class="sub-btn" onclick="updateChartType('pie')">Circle (Pie) Graph</button>
            </div>
            <div style="height: 400px; position: relative;">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        let currentChartType = 'bar';

        function updateVal(id, val) {
            document.getElementById('v-' + id).innerText = val;
            document.getElementById('box-' + id).value = val;
            calculateAverage();
            if(document.getElementById('graph-section').style.display === 'block') renderChart();
        }

        function syncFromBox(id, val) {
            document.getElementById(id).value = val;
            document.getElementById('v-' + id).innerText = val;
            calculateAverage();
            if(document.getElementById('graph-section').style.display === 'block') renderChart();
        }

        function fetchCSVData() {
            const csvData = "5.8,65,45,35,1.5,40,85,70"; 
            const values = csvData.split(',');
            const keys = ['ph', 'n', 'p', 'k', 'om', 'sm', 'pm', 'hi'];
            
            keys.forEach((key, index) => {
                const val = values[index];
                document.getElementById(key).value = val;
                document.getElementById('box-' + key).value = val;
                document.getElementById('v-' + key).innerText = val;
            });
            
            calculateAverage();
            alert("Data Loaded from CSV successfully!");
        }

        function calculateAverage() {
            const ids = ['ph', 'n', 'p', 'k', 'om', 'sm', 'pm', 'hi'];
            let sum = 0;
            ids.forEach(id => sum += parseFloat(document.getElementById(id).value));
            const avg = (sum / ids.length).toFixed(2);
            document.getElementById('avg-display').innerText = avg;
        }

        function toggleGraph() {
            const section = document.getElementById('graph-section');
            section.style.display = (section.style.display === 'none') ? 'block' : 'none';
            if (section.style.display === 'block') renderChart();
        }

        function updateChartType(type) {
            currentChartType = type;
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            const dataValues = ['ph', 'n', 'p', 'k', 'om', 'sm', 'pm', 'hi'].map(id => document.getElementById(id).value);
            const labels = ['pH', 'Nitrogen', 'Phosphorous', 'Potassium', 'Organic', 'Moisture', 'Pests', 'Health'];

            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Values',
                        data: dataValues,
                        backgroundColor: ['#ff5722', '#2196f3', '#4caf50', '#ffeb3b', '#9c27b0', '#00bcd4', '#e91e63', '#8bc34a']
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: currentChartType === 'pie', labels: {color: 'white'} } }
                }
            });
        }

function runRandomForest() {

    const ph = parseFloat(document.getElementById('ph').value);
    const n  = parseFloat(document.getElementById('n').value);
    const p  = parseFloat(document.getElementById('p').value);
    const k  = parseFloat(document.getElementById('k').value);
    const om = parseFloat(document.getElementById('om').value);

    const light = document.getElementById('status-light');
    const statusText = document.getElementById('prediction-text');
    const recArea = document.getElementById('recommendations');

    let errors = [];
    let recommendations = [];

    if (ph < 6) {
        errors.push("Low pH (Acidic Soil)");
        recommendations.push("Apply Agricultural Lime to raise pH.");
    }
    else if (ph > 7.5) {
        errors.push("High pH (Alkaline Soil)");
        recommendations.push("Apply Gypsum and Organic Compost.");
    }

    if (n > 55) {
        errors.push("Nitrogen Toxicity");
        recommendations.push("Stop Urea. Apply carbon-rich compost.");
    }
    else if (n < 30) {
        errors.push("Low Nitrogen");
        recommendations.push("Apply Urea or Ammonium Sulphate.");
    }

    if (p < 20) {
        errors.push("Low Phosphorous");
        recommendations.push("Apply DAP or Bone Meal.");
    }
    else if (p > 60) {
        errors.push("High Phosphorous");
        recommendations.push("Avoid DAP. Apply Zinc fertilizer.");
    }

    if (k < 20) {
        errors.push("Low Potassium");
        recommendations.push("Apply Muriate of Potash (MOP).");
    }
    else if (k > 60) {
        errors.push("High Potassium");
        recommendations.push("Avoid Potash. Flush soil with water.");
    }

    if (om < 2.0) {
        errors.push("Low Organic Matter");
        recommendations.push("Apply Vermicompost or Farmyard Manure.");
    }

    if (n > 55 && p > 60) {
        recommendations.push("Use Balanced NPK fertilizer instead of separate N and P.");
    }
    if (p > 60 && k > 60) {
        recommendations.push("Apply NPK 10-26-26 balanced fertilizer.");
    }
    if (n > 55 && p > 60 && k > 60) {
        recommendations.push("Stop all chemical fertilizers immediately and flush soil.");
    }

    let soilMoisture = (100 - (n / 2)).toFixed(0);
    let pestMortality = (p > 30 ? 90 : 70);
    let healthIndex = (errors.length === 0 ? 95 : 60);

    document.getElementById('sm').value = soilMoisture;
    document.getElementById('v-sm').innerText = soilMoisture;

    document.getElementById('pm').value = pestMortality;
    document.getElementById('v-pm').innerText = pestMortality;

    document.getElementById('hi').value = healthIndex;
    document.getElementById('v-hi').innerText = healthIndex;

    calculateAverage();

    if (errors.length > 0) {
        light.className = "glowing-circle glow-red";
        statusText.innerText = "Toxicity Detected (Bad)";
        statusText.style.color = "#ff4d4d";

        recArea.innerHTML = `
            <div class="fade-in" style="background:#111;padding:20px;border:1px solid #ff4d4d;border-radius:10px;text-align:left;">
                <h4 style="color:#ff4d4d;">Detected Issues:</h4>
                <ul>${errors.map(e => `<li>${e}</li>`).join('')}</ul>
                <h4 style="color:#00ff88;">Fertilizer Recommendations:</h4>
                <ul>${recommendations.map(r => `<li>${r}</li>`).join('')}</ul>
            </div>`;
    }
    else {
        light.className = "glowing-circle glow-green";
        statusText.innerText = "Optimal Conditions (Good)";
        statusText.style.color = "#00ff88";
        recArea.innerHTML = "";
    }
}

        window.onload = calculateAverage;
    </script>
</body>

</html>

